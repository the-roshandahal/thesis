{% extends 'base_dashboard.html' %} {% load static %} {% block title %}Assessment Detail - Thesis Management System{% endblock %} {% block sidebar_menu %} {% if user_is_supervisor %} {% include 'supervisor_sidebar.html' %} {% elif user_is_admin %} {% include 'admin_sidebar.html' %} {% else %}
<!-- Student sidebar or no sidebar -->
{% endif %} {% endblock %} {% block content %}

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Page Title -->
<div class="row">
  <div class="col-12">
    <div class="page-title-box d-flex align-items-center justify-content-between">
      <h4 class="mb-0">{{ assessment.title }}</h4>
      <div class="page-title-right">
        <ol class="breadcrumb m-0">
          {% if user_is_supervisor %}
          <li class="breadcrumb-item"><a href="{% url 'supervisor_dashboard' %}">Dashboard</a></li>
          {% elif user_is_admin %}
          <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
          {% endif %}
          <li class="breadcrumb-item"><a href="{% url 'grading:grading' %}">Grading</a></li>
          <li class="breadcrumb-item active">{{ assessment.title|truncatechars:30 }}</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Assessment Header -->
<div class="card shadow-sm mb-4">
  <div class="card-header py-3 bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="m-0 font-weight-bold text-white">
        <i class="mdi mdi-clipboard-check me-2"></i>
        {{ assessment.title }}
      </h4>
      <span class="badge badge-light"> Due: {{ assessment.due_date|date:"M d, Y" }} </span>
    </div>
  </div>
  <div class="card-body bg-light">
    <div class="row">
      <div class="col-md-3">
        <div class="detail-item">
          <h5>Total Marks</h5>
          <p>{{ assessment.weight }}</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="detail-item">
          <h5>Average Grade</h5>
          <p>{{ avg_grade|default:"-" }}/{{ assessment.weight }}</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="detail-item">
          <h5>Total Submissions</h5>
          <p>{{ submissions.count }}</p>
        </div>
      </div>
      {% if published_status == 'unpublished' %}
      <div class="col-md-3">
        <button type="button" class="btn btn-primary waves-effect waves-light" onclick="publishGrades({{ assessment.id }})"><i class="mdi mdi-publish me-1"></i>Publish Grades</button>
      </div>
      {% else %}
      <div class="col-md-3">
        <span class="badge badge-success"> <i class="mdi mdi-check-circle me-1"></i>Published </span>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Submissions Table -->
<div class="card shadow-sm mb-4">
  <div class="card-header py-3">
    <h5 class="m-0 font-weight-bold text-primary">
      <i class="mdi mdi-account-group me-2"></i>
      Student Submissions
    </h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="thead-dark">
          <tr>
            <th>Student</th>
            <th>Project</th>
            <th>Submitted</th>
            <th>Grade</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for submission in submissions %}
          <tr>
            <td>{{ submission.submitted_by.get_full_name }}</td>
            <td>{{ submission.application.project.title }}</td>
            <td>{{ submission.submitted_at|date:"M d, Y H:i" }}</td>
            <td>
              {% if submission.grades_received %} {{ submission.grades_received }}/{{ assessment.weight }} {% else %}
              <span class="text-muted">Pending</span>
              {% endif %}
            </td>
            <td>
              {% if submission.is_late %}
              <span class="badge bg-danger"> <i class="mdi mdi-clock-alert me-1"></i>Late </span>
              {% else %}
              <span class="badge bg-success"> <i class="mdi mdi-clock-check me-1"></i>On Time </span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'grading:grade_submission' submission.id %}" class="btn btn-sm btn-primary"> <i class="mdi mdi-pencil me-1"></i> Grade </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">No submissions found for this assessment.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function publishGrades(assessmentId) {
    if (!confirm("Are you sure you want to publish grades for this assessment? This action cannot be undone.")) {
      return;
    }

    // Get the button that was clicked
    const button = document.querySelector(`button[onclick="publishGrades(${assessmentId})"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="mdi mdi-loading mdi-spin me-1"></i>Publishing...';
    button.disabled = true;

    // Make AJAX request to publish grades
    fetch(`/grading/assessments/${assessmentId}/publish/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Show success message
          alert(data.message);
          // Reload the page to show updated status
          location.reload();
        } else {
          // Show error message
          alert("Error: " + (data.error || "Failed to publish grades"));
          // Reset button state
          button.innerHTML = originalText;
          button.disabled = false;
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while publishing grades. Please try again.");
        // Reset button state
        button.innerHTML = originalText;
        button.disabled = false;
      });
  }
</script>

{% endblock %}
